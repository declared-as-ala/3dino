<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Pose2BVH - Motion Capture</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
          }
        }
      }
    }
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="three.min.js"></script>
  <script src="bvh_converter.js"></script>
  

  <script>
    var faceLandmarker;
    var faceResults;

    var holisticResults;

    let camera, scene, renderer, stats;
    var model;
    var animation;
    var animationDuration;
    let camera_bvh, controls_bvh, scene_bvh, renderer_bvh;
    let mixer_bvh, skeletonHelper_bvh;

    var args = window.location.hash.replace("#", "").split(",");
    var fbxfile = args[0] || "ybot.fbx";
    var trackingLine;
    var line_tracker = []; // Start with an empty array

    var facemesh;
    
    // Mode switching
    var currentMode = 'tracking'; // 'tracking' or 'animation'
    var currentAnimation = null;
    var animationMixer = null;

  </script>

  <style>
    * {
      font-family: 'Inter', sans-serif;
    }
    
    #results {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      color: black;
    }

    #results div {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 200px;
      min-height: 200px;
      overflow-y: hidden;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.5);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(99, 102, 241, 0.7);
    }

    /* Smooth transitions */
    .mode-card {
      transition: all 0.3s ease;
    }
    
    .mode-card:hover {
      transform: translateY(-2px);
    }

    .mode-card.active {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-color: #6366f1;
    }

    /* Ensure select dropdown works properly */
    #animationSelect {
      position: relative;
      z-index: 10001;
    }

    #animationSelect option {
      background-color: #1f2937 !important;
      color: white !important;
      padding: 10px;
    }

    /* Fix for dropdown visibility */
    select:focus {
      z-index: 10002;
    }
  </style>

</head>

<body class="m-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 overflow-hidden">

  <!-- Camera Video - Bottom Right with Modern Design -->
  <div class="fixed bottom-4 right-4 z-[999999] group" style="max-width: calc(100vw - 2rem);">
    <div class="relative">
      <video id="video" class="w-32 sm:w-40 md:w-56 lg:w-72 xl:w-80 h-auto rounded-xl shadow-2xl border-2 border-indigo-500/50 transform -rotate-3 transition-all duration-300 group-hover:rotate-0 group-hover:scale-105 max-w-[calc(100vw-20rem)] sm:max-w-none" autoplay></video>
      <div class="absolute -top-2 -right-2 w-3 h-3 sm:w-4 sm:h-4 bg-green-500 rounded-full border-2 border-gray-900 animate-pulse"></div>
      <div class="absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
        Live Camera
      </div>
    </div>
  </div>

  <!-- Modern Control Panel -->
  <div class="fixed top-4 left-4 right-4 sm:left-auto sm:right-6 sm:top-6 z-[10000] w-auto sm:w-auto max-w-sm" style="overflow: visible;">
    <div class="bg-gray-800/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-700/50" style="overflow: visible;">
      <!-- Header -->
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
        <h2 class="text-white text-xl font-bold flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          Control Panel
        </h2>
      </div>

      <!-- Content -->
      <div class="p-6 space-y-6">
        <!-- Mode Selection -->
        <div>
          <h3 class="text-gray-300 text-sm font-semibold uppercase tracking-wider mb-4">Select Mode</h3>
          <div class="grid grid-cols-2 gap-3">
            <!-- Tracking Mode Card -->
            <button 
              id="trackingModeBtn"
              onclick="switchMode('tracking')"
              class="mode-card active bg-gray-700/50 border-2 border-gray-600 rounded-xl p-4 text-left cursor-pointer hover:bg-gray-700"
            >
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center">
                  <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <div class="text-white font-semibold text-sm">Tracking</div>
                  <div class="text-gray-400 text-xs">Real-time</div>
                </div>
              </div>
            </button>

            <!-- Animation Mode Card -->
            <button 
              id="animationModeBtn"
              onclick="switchMode('animation')"
              class="mode-card bg-gray-700/50 border-2 border-gray-600 rounded-xl p-4 text-left cursor-pointer hover:bg-gray-700"
            >
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                  <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div>
                  <div class="text-white font-semibold text-sm">Animation</div>
                  <div class="text-gray-400 text-xs">Pre-loaded</div>
                </div>
              </div>
            </button>
          </div>
        </div>
  
        <!-- Animation Selection (shown when Animation Mode is active) -->
        <div id="animationControls" class="hidden space-y-3">
          <div class="border-t border-gray-700 pt-4">
            <label class="text-gray-300 text-sm font-semibold uppercase tracking-wider mb-3 block">Select Animation</label>
            <div class="relative" style="z-index: 10001;">
              <select 
                id="animationSelect" 
                onchange="loadSelectedAnimation()"
                onclick="this.style.zIndex='10003'"
                onblur="this.style.zIndex='10001'"
                class="w-full bg-gray-700 border-2 border-gray-600 text-white rounded-xl px-4 py-3 pr-10 cursor-pointer hover:border-indigo-500 focus:border-indigo-500 focus:outline-none transition-colors text-sm"
                style="position: relative; z-index: 10001;"
              >
                <option value="" style="background-color: #374151; color: white; padding: 10px;">-- Select Animation --</option>
                <option value="Chicken Dance.fbx" style="background-color: #374151; color: white; padding: 10px;">Chicken Dance</option>
                <option value="Fast Run.fbx" style="background-color: #374151; color: white; padding: 10px;">Fast Run</option>
              </select>
            </div>
            <p class="text-gray-500 text-xs mt-2">Choose a pre-loaded animation to play</p>
          </div>
        </div>

        <!-- Status Indicator -->
        <div class="border-t border-gray-700 pt-4">
          <div class="flex items-center justify-between">
            <span class="text-gray-400 text-sm">Status</span>
            <div class="flex items-center gap-2">
              <div id="statusIndicator" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
              <span id="statusText" class="text-green-400 text-sm font-medium">Tracking Active</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  function switchMode(mode) {
    currentMode = mode;
    const animationControls = document.getElementById('animationControls');
    const trackingBtn = document.getElementById('trackingModeBtn');
    const animationBtn = document.getElementById('animationModeBtn');
    const statusText = document.getElementById('statusText');
    
    // Update button states
    if (mode === 'animation') {
      animationControls.classList.remove('hidden');
      trackingBtn.classList.remove('active');
      trackingBtn.classList.add('bg-gray-700/50', 'border-gray-600');
      animationBtn.classList.add('active');
      animationBtn.classList.remove('bg-gray-700/50', 'border-gray-600');
      statusText.textContent = 'Animation Mode';
      statusText.className = 'text-purple-400 text-sm font-medium';
      
      // Stop any current tracking by clearing holistic results temporarily
      // The tracking code already checks for currentMode === 'tracking'
    } else {
      animationControls.classList.add('hidden');
      trackingBtn.classList.add('active');
      trackingBtn.classList.remove('bg-gray-700/50', 'border-gray-600');
      animationBtn.classList.remove('active');
      animationBtn.classList.add('bg-gray-700/50', 'border-gray-600');
      statusText.textContent = 'Tracking Active';
      statusText.className = 'text-green-400 text-sm font-medium';
      
      // Stop any current animation
      if (currentAnimation) {
        currentAnimation.stop();
        currentAnimation = null;
      }
      if (animationMixer) {
        animationMixer.stopAllAction();
      }
      // Reset clock when switching back to tracking
      if (window.clock) {
        window.clock.start();
      }
    }
  }
  
  function loadSelectedAnimation() {
    const select = document.getElementById('animationSelect');
    const animationFile = select.value;
    const statusText = document.getElementById('statusText');
    
    console.log('Animation selected:', animationFile); // Debug log
    
    if (animationFile && window.loadAnimation) {
      statusText.textContent = 'Loading Animation...';
      statusText.className = 'text-yellow-400 text-sm font-medium';
      
      // Reset clock when loading new animation
      if (window.clock) {
        window.clock.start();
      }
      
      // Add a small delay to show loading state
      setTimeout(() => {
        window.loadAnimation(animationFile);
        statusText.textContent = 'Animation Playing';
        statusText.className = 'text-purple-400 text-sm font-medium';
      }, 100);
    } else if (!animationFile) {
      // If no animation selected, stop current animation
      if (currentAnimation) {
        currentAnimation.stop();
        currentAnimation = null;
      }
      if (animationMixer) {
        animationMixer.stopAllAction();
      }
      statusText.textContent = 'Animation Mode';
      statusText.className = 'text-purple-400 text-sm font-medium';
    }
  }

  // Ensure dropdown works on all browsers
  document.addEventListener('DOMContentLoaded', function() {
    const select = document.getElementById('animationSelect');
    if (select) {
      // Force the select to be visible and functional
      select.style.display = 'block';
      select.style.visibility = 'visible';
      select.style.opacity = '1';
      
      // Add click handler to ensure dropdown opens
      select.addEventListener('mousedown', function(e) {
        this.style.zIndex = '10003';
        this.focus();
      });
      
      select.addEventListener('blur', function() {
        this.style.zIndex = '10001';
      });
    }
  });
</script>

  <script type="module" src="./script.js"></script>
  <script type="module" src="threejsscene.js"></script>
  

</body>

</html>