<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>pose2bvh</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="three.min.js"></script>
  <script src="bvh_converter.js"></script>
  

  <script>
    var faceLandmarker;
    var faceResults;

    var holisticResults;

    let camera, scene, renderer, stats;
    var model;
    var animation;
    var animationDuration;
    let camera_bvh, controls_bvh, scene_bvh, renderer_bvh;
    let mixer_bvh, skeletonHelper_bvh;

    var args = window.location.hash.replace("#", "").split(",");
    var fbxfile = args[0] || "ybot.fbx";
    var trackingLine;
    var line_tracker = []; // Start with an empty array
    var bvhRecorderFrequency = 20;
    var lastFrameTime = -1;
    var recordStartTime = -1;

    var facemesh;
    var lastUpdateFrameTime = 0;
    
    // Mode switching
    var currentMode = 'tracking'; // 'tracking' or 'animation'
    var currentAnimation = null;
    var animationMixer = null;

  </script>

  <style>
    #results {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      color: black;
    }

    #results div {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 200px;
      min-height: 200px;
      overflow-y: hidden;
    }
  </style>

</head>

<body style="margin:0;background:#232323">

  <video id="video" style="z-index:999999;width:100vw;max-width:300px;height:auto;position: fixed;
  top: 20px;
  left: 20px;
  border: 10px #e0e0e0 solid;
  box-shadow: 5px 5px 10px 2px gray;
  transform: rotate(-5deg);" autoplay></video>


<script>
  let isRecording = false;

  function toggleRecording() {
    const recordButton = document.getElementById('recordButton');
    const recordIcon = recordButton.querySelector('i');
    if (!isRecording) {
      startRecording();
      recordButton.classList.remove('green');
      recordButton.classList.add('red');
      recordIcon.textContent = 'stop';
      recordButton.innerHTML = recordButton.innerHTML.replace('Record BVH', 'Stop Recording');
    } else {
      stopRecording();
      recordButton.classList.remove('red');
      recordButton.classList.add('green');
      recordIcon.textContent = 'fiber_manual_record';
      recordButton.innerHTML = recordButton.innerHTML.replace('Stop Recording', 'Record BVH');
      recordStartTime = -1;
      document.getElementById('recdetails').innerHTML = "Not Recording...";
    }

    isRecording = !isRecording;
  }
  var firstFrameJointData;
  function startRecording() {
    recording = true;
    recordedMotionData = [];
    recordStartTime = Date.now();
  }

  var recording = false;
  function stopRecording() {
    recording = false;

    // Call generateBVH and save the BVH file
    // console.log(recordedMotionData.length);
    const bvhContent = generateBVH(firstFrameJointData, recordedMotionData);
    const blob = new Blob([bvhContent], { type: "text/plain;charset=utf-8" });
    const date = new Date();
    const dateString = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}-${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}`;
    const file_name = `Mocap_bvh_${dateString}.bvh`;
    saveAs(blob, file_name);
  }

</script>

<!-- Mode Selection Panel -->
<div style="position:fixed; top:20px; right:20px; z-index:10000; background:rgba(0,0,0,0.8); padding:20px; border-radius:10px; color:white;">
  <h5 style="margin-top:0; color:white;">Mode Selection</h5>
  <div style="margin-bottom:15px;">
    <label style="color:white;">
      <input name="mode" type="radio" value="tracking" checked onchange="switchMode('tracking')" />
      <span style="color:white;">Tracking Mode</span>
    </label>
  </div>
  <div style="margin-bottom:15px;">
    <label style="color:white;">
      <input name="mode" type="radio" value="animation" onchange="switchMode('animation')" />
      <span style="color:white;">Animation Mode</span>
    </label>
  </div>
  
  <div id="animationControls" style="display:none; margin-top:15px;">
    <label style="color:white; display:block; margin-bottom:10px;">Select Animation:</label>
    <select id="animationSelect" class="browser-default" style="background:white; color:black; padding:5px; border-radius:5px; width:100%;" onchange="loadSelectedAnimation()">
      <option value="">-- Select Animation --</option>
      <option value="Chicken Dance.fbx">Chicken Dance</option>
      <option value="Fast Run.fbx">Fast Run</option>
    </select>
  </div>
</div>

<p id="recdetails" style="z-index:9999;position:fixed;bottom:20px;left:5px;color:white;padding:10px;">
  Not Recording...
</p>
<button id="recordButton" style="position:absolute; left:0; bottom:0px; z-index: 1001;"
    class="main btn waves-effect waves-light green black-text large" onclick="toggleRecording()">
    <i class="material-icons" style="vertical-align:middle;font-size:200%">fiber_manual_record</i>
    Record BVH
  </button>

<script>
  function switchMode(mode) {
    currentMode = mode;
    const animationControls = document.getElementById('animationControls');
    if (mode === 'animation') {
      animationControls.style.display = 'block';
      // Stop any current tracking by clearing holistic results temporarily
      // The tracking code already checks for currentMode === 'tracking'
    } else {
      animationControls.style.display = 'none';
      // Stop any current animation
      if (currentAnimation) {
        currentAnimation.stop();
        currentAnimation = null;
      }
      if (animationMixer) {
        animationMixer.stopAllAction();
      }
      // Reset clock when switching back to tracking
      if (window.clock) {
        window.clock.start();
      }
    }
  }
  
  function loadSelectedAnimation() {
    const select = document.getElementById('animationSelect');
    const animationFile = select.value;
    if (animationFile && window.loadAnimation) {
      // Reset clock when loading new animation
      if (window.clock) {
        window.clock.start();
      }
      window.loadAnimation(animationFile);
    } else if (!animationFile) {
      // If no animation selected, stop current animation
      if (currentAnimation) {
        currentAnimation.stop();
        currentAnimation = null;
      }
      if (animationMixer) {
        animationMixer.stopAllAction();
      }
    }
  }
</script>

  <script type="module" src="./script.js"></script>
  <script type="module" src="threejsscene.js"></script>
  

</body>

</html>